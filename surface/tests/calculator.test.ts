import {
  getLcaResults,
  postLca,
  postOrganization,
  deleteOrganization,
} from "./lib/request"
import {
  expectGetLcaResultsResponses,
  expectPostLcaResponses,
} from "./lib/expect"
import { Methodology } from "lib/calculator/methodologies"
import { sumLca } from "lib/calculator/results"
import {
  TransportFactor,
  UseFactor,
  EndOfLifeFactor,
  makeLCA,
} from "./mocks/calculator"

const TEST_ORG_ID = "test_org_id"

beforeAll(async () => {
  const organization = {
    id: TEST_ORG_ID,
    skipEmail: true,
  }

  const response = await postOrganization(organization)
  expect(response.organization.statusCode).toBe(200)
})

afterAll(() => {
  // Delete the organization will cascade and delete all the related data.
  deleteOrganization(TEST_ORG_ID)
})

test("the calculator works", async () => {
  const lca = makeLCA(TEST_ORG_ID, {
    materials: {
      weight_grams: 2583,
      subcomponents: [
        { weight_grams: 291 },
        { weight_grams: 38, subcomponents: [{ weight_grams: 45 }] },
      ],
    },
    transport: [
      {
        weight_grams: 291,
        distance_km: 1500,
        factor: TransportFactor.AIR,
      },
    ],
    manufacturing: [
      {
        quantity_kwh: 9188,
        quantity_mj: 4877,
        percent_renewable: 48,
        percent_revenue: 21,
        quantity_produced: 63790,
      },
    ],
    use: [
      {
        service_life_quantity: 3888,
        use_quantity: 2500,
        factor: UseFactor.WATER,
      },
    ],
    endOfLife: [
      {
        weight_grams: 2583,
        factor: EndOfLifeFactor.LANDFILL,
      },
    ],
  })

  const postResponses = await postLca(lca)
  expectPostLcaResponses(postResponses)

  const getCmlResponses = await getLcaResults(lca.lca_id, Methodology.CML)
  expectGetLcaResultsResponses(getCmlResponses)

  const getEfResponses = await getLcaResults(lca.lca_id, Methodology.EF)
  expectGetLcaResultsResponses(getEfResponses)

  const getRmhResponses = await getLcaResults(lca.lca_id, Methodology.RMH)
  expectGetLcaResultsResponses(getRmhResponses)

  expect(sumLca(Methodology.CML, getCmlResponses)).toMatchObject({
    material: {
      total_acidification: 0,
      total_global_warming: 0,
      total_freshwater_ecotoxicity: 0,
      total_marine_ecotoxicity: 0,
      total_terrestrial_ecotoxicity: 0,
      total_abiotic_depletion_fossil_fuels: 0,
      total_eutrophication: 0,
      total_human_toxicity: 0,
      total_abiotic_depletion: 0,
      total_ozone_depletion: 0,
      total_photochemical_ozone_creation: 0,
    },
    transportation: {
      total_global_warming: 0.4020434014012333,
      total_acidification: 0.0012912683184789508,
      total_eutrophication: 0.00026591128597008796,
      total_ozone_depletion: 5.0447229927869545e-9,
      total_human_toxicity: 0.07735935506279285,
      total_freshwater_ecotoxicity: 0.019444424339146497,
      total_marine_ecotoxicity: 45.94803388250154,
      total_terrestrial_ecotoxicity: 0.0006762069869192455,
      total_abiotic_depletion: 8.036382533193121e-8,
      total_abiotic_depletion_fossil_fuels: 5.361854490392595,
      total_photochemical_ozone_creation: 0.00009376440484000923,
    },
    facility: {
      total_global_warming: 0.007157679236913554,
      total_acidification: 0.000011910174248657894,
      total_eutrophication: 0.0000186807752750888,
      total_ozone_depletion: 3.294209373098545e-11,
      total_human_toxicity: 0.004262962355547314,
      total_freshwater_ecotoxicity: 0.003795365999540049,
      total_marine_ecotoxicity: 9.608380406382077,
      total_terrestrial_ecotoxicity: 0.000018553358717087694,
      total_abiotic_depletion: 9.891727164423269e-9,
      total_abiotic_depletion_fossil_fuels: 0.09244210435660948,
      total_photochemical_ozone_creation: 8.956439151437319e-7,
    },
    use: {
      total_global_warming: null,
      total_acidification: null,
      total_eutrophication: null,
      total_ozone_depletion: null,
      total_human_toxicity: null,
      total_freshwater_ecotoxicity: null,
      total_marine_ecotoxicity: null,
      total_terrestrial_ecotoxicity: null,
      total_abiotic_depletion: null,
      total_abiotic_depletion_fossil_fuels: null,
      total_photochemical_ozone_creation: null,
    },
    disposal: {
      total_global_warming: 0.007355794665923326,
      total_acidification: 0.00004748826185926574,
      total_eutrophication: 0.000011434501027729026,
      total_ozone_depletion: 9.079391637842607e-11,
      total_human_toxicity: 0.005132480497811268,
      total_freshwater_ecotoxicity: 0.0008873954353393011,
      total_marine_ecotoxicity: 1.765345378211364,
      total_terrestrial_ecotoxicity: 0.000013071628654637055,
      total_abiotic_depletion: 2.6484660272310484e-9,
      total_abiotic_depletion_fossil_fuels: 0.094548439813467,
      total_photochemical_ozone_creation: 0.000004348805815241537,
    },
    lca: {
      total_global_warming: 0.4165568753040702,
      total_acidification: 0.0013506667545868745,
      total_eutrophication: 0.00029602656227290577,
      total_ozone_depletion: 5.1684590028963666e-9,
      total_human_toxicity: 0.08675479791615143,
      total_freshwater_ecotoxicity: 0.02412718577402585,
      total_marine_ecotoxicity: 57.32175966709498,
      total_terrestrial_ecotoxicity: 0.0007078319742909702,
      total_abiotic_depletion: 9.290401852358552e-8,
      total_abiotic_depletion_fossil_fuels: 5.548845034562672,
      total_photochemical_ozone_creation: 0.00009900885457039451,
    },
  })

  expect(sumLca(Methodology.EF, getEfResponses)).toMatchObject({
    material: {
      total_acidification: 0,
      total_global_warming: 0,
      total_biogenic_global_warming: 0,
      total_fossil_fuel_global_warming: 0,
      total_land_use_global_warming: 0,
      total_freshwater_ecotoxicity: 0,
      total_freshwater_inorganics_ecotoxicity: 0,
      total_freshwater_organics_ecotoxicity: 0,
      total_abiotic_depletion_fossil_fuels: 0,
      total_freshwater_eutrophication: 0,
      total_marine_eutrophication: 0,
      total_terrestrial_eutrophication: 0,
      total_carcinogenic_human_toxicity: 0,
      total_carcinogenic_inorganics_human_toxicity: 0,
      total_carcinogenic_organics_human_toxicity: 0,
      total_non_carcinogenic_human_toxicity: 0,
      total_non_carcinogenic_inorganics_human_toxicity: 0,
      total_non_carcinogenic_organics_human_toxicity: 0,
      total_ionizing_radiation: 0,
      total_land_use: 0,
      total_abiotic_depletion: 0,
      total_ozone_depletion: 0,
      total_particulate_matter_formation: 0,
      total_human_health_photochemical_ozone_creation: 0,
      total_water_use: 0,
    },
    transportation: {
      total_acidification: 0.0017595826041461621,
      total_global_warming: 0.4039432256260121,
      total_biogenic_global_warming: 0.000035316162319497916,
      total_fossil_fuel_global_warming: 0.40387627042225743,
      total_land_use_global_warming: 0.00003163904143522829,
      total_freshwater_ecotoxicity: 2.6142605155875804,
      total_freshwater_inorganics_ecotoxicity: 2.5270260499672834,
      total_freshwater_organics_ecotoxicity: 0.08723446562029884,
      total_abiotic_depletion_fossil_fuels: 5.384764787000074,
      total_freshwater_eutrophication: 0.0000055659493658179015,
      total_marine_eutrophication: 0.0007134856560049221,
      total_terrestrial_eutrophication: 0.007649094197239697,
      total_carcinogenic_human_toxicity: 4.248485086841813e-11,
      total_carcinogenic_inorganics_human_toxicity: 2.807589069744233e-11,
      total_carcinogenic_organics_human_toxicity: 1.4408960170975831e-11,
      total_non_carcinogenic_human_toxicity: 4.311824246364951e-9,
      total_non_carcinogenic_inorganics_human_toxicity: 4.245679671948991e-9,
      total_non_carcinogenic_organics_human_toxicity: 6.614457441596192e-11,
      total_ionizing_radiation: 0.0016646003397963736,
      total_land_use: 0.3351772369736227,
      total_abiotic_depletion: 8.349221522823496e-8,
      total_ozone_depletion: 6.319785134839757e-9,
      total_particulate_matter_formation: 3.749957470256607e-9,
      total_human_health_photochemical_ozone_creation: 0,
      total_water_use: 0.0071531862216902675,
    },
    facility: {
      total_acidification: 0.000014940107471865389,
      total_global_warming: 0.007193188385756259,
      total_biogenic_global_warming: 0.000008588324632909582,
      total_fossil_fuel_global_warming: 0.007183981649715667,
      total_land_use_global_warming: 6.184114076798236e-7,
      total_freshwater_ecotoxicity: 0.01557450351251046,
      total_freshwater_inorganics_ecotoxicity: 0.013494970553199015,
      total_freshwater_organics_ecotoxicity: 0.0020795329593114357,
      total_abiotic_depletion_fossil_fuels: 0.11123071678958169,
      total_freshwater_eutrophication: 0.000005527103841166686,
      total_marine_eutrophication: 0.0000046982118704664604,
      total_terrestrial_eutrophication: 0.00004016778868863771,
      total_carcinogenic_human_toxicity: 1.5506595397519347e-12,
      total_carcinogenic_inorganics_human_toxicity: 1.0131868336597979e-12,
      total_carcinogenic_organics_human_toxicity: 5.374727060921358e-13,
      total_non_carcinogenic_human_toxicity: 4.623104836417469e-11,
      total_non_carcinogenic_inorganics_human_toxicity: 4.482782399224623e-11,
      total_non_carcinogenic_organics_human_toxicity: 1.4032243719284817e-12,
      total_ionizing_radiation: 0.001216584056431335,
      total_land_use: 0.016313927476069228,
      total_abiotic_depletion: 9.978213526633896e-9,
      total_ozone_depletion: 3.797867743380767e-11,
      total_particulate_matter_formation: 1.0529162943012922e-10,
      total_human_health_photochemical_ozone_creation: 0,
      total_water_use: 0.0019844090601942106,
    },
    use: {
      total_acidification: null,
      total_global_warming: null,
      total_biogenic_global_warming: null,
      total_fossil_fuel_global_warming: null,
      total_land_use_global_warming: null,
      total_freshwater_ecotoxicity: null,
      total_freshwater_inorganics_ecotoxicity: null,
      total_freshwater_organics_ecotoxicity: null,
      total_abiotic_depletion_fossil_fuels: null,
      total_freshwater_eutrophication: null,
      total_marine_eutrophication: null,
      total_terrestrial_eutrophication: null,
      total_carcinogenic_human_toxicity: null,
      total_carcinogenic_inorganics_human_toxicity: null,
      total_carcinogenic_organics_human_toxicity: null,
      total_non_carcinogenic_human_toxicity: null,
      total_non_carcinogenic_inorganics_human_toxicity: null,
      total_non_carcinogenic_organics_human_toxicity: null,
      total_ionizing_radiation: null,
      total_land_use: null,
      total_abiotic_depletion: null,
      total_ozone_depletion: null,
      total_particulate_matter_formation: null,
      total_human_health_photochemical_ozone_creation: null,
      total_water_use: null,
    },
    disposal: {
      total_acidification: 0.00006672978333886436,
      total_global_warming: 0.00739416742452607,
      total_biogenic_global_warming: 0.0000012289629767840412,
      total_fossil_fuel_global_warming: 0.007392059682397712,
      total_land_use_global_warming: 8.787791515717169e-7,
      total_freshwater_ecotoxicity: 0.04461640103487845,
      total_freshwater_inorganics_ecotoxicity: 0.04299910305484609,
      total_freshwater_organics_ecotoxicity: 0.001617297980032367,
      total_abiotic_depletion_fossil_fuels: 0.09526724700595947,
      total_freshwater_eutrophication: 3.7530260106162296e-7,
      total_marine_eutrophication: 0.00002995956928511815,
      total_terrestrial_eutrophication: 0.00032538939733198175,
      total_carcinogenic_human_toxicity: 2.3354588379075003e-12,
      total_carcinogenic_inorganics_human_toxicity: 1.0246189717695272e-12,
      total_carcinogenic_organics_human_toxicity: 1.3108398661379733e-12,
      total_non_carcinogenic_human_toxicity: 1.8847217287904837e-11,
      total_non_carcinogenic_inorganics_human_toxicity: 1.6901701242368677e-11,
      total_non_carcinogenic_organics_human_toxicity: 1.9455160455361773e-12,
      total_ionizing_radiation: 0.000048084168880302174,
      total_land_use: 0.11288404116701328,
      total_abiotic_depletion: 2.7127359338298877e-9,
      total_ozone_depletion: 1.1125558252473578e-10,
      total_particulate_matter_formation: 1.8272874018324369e-9,
      total_human_health_photochemical_ozone_creation: 0,
      total_water_use: 0.0002457331503700502,
    },
    lca: {
      total_acidification: 0.001841252494956892,
      total_global_warming: 0.41853058143629446,
      total_biogenic_global_warming: 0.00004513344992919154,
      total_fossil_fuel_global_warming: 0.4184523117543708,
      total_land_use_global_warming: 0.00003313623199447983,
      total_freshwater_ecotoxicity: 2.6744514201349694,
      total_freshwater_inorganics_ecotoxicity: 2.5835201235753282,
      total_freshwater_organics_ecotoxicity: 0.09093129655964263,
      total_abiotic_depletion_fossil_fuels: 5.5912627507956145,
      total_freshwater_eutrophication: 0.000011468355808046212,
      total_marine_eutrophication: 0.0007481434371605067,
      total_terrestrial_eutrophication: 0.008014651383260317,
      total_carcinogenic_human_toxicity: 4.637096924607757e-11,
      total_carcinogenic_inorganics_human_toxicity: 3.011369650287165e-11,
      total_carcinogenic_organics_human_toxicity: 1.625727274320594e-11,
      total_non_carcinogenic_human_toxicity: 4.37690251201703e-9,
      total_non_carcinogenic_inorganics_human_toxicity: 4.307409197183606e-9,
      total_non_carcinogenic_organics_human_toxicity: 6.949331483342657e-11,
      total_ionizing_radiation: 0.002929268565108011,
      total_land_use: 0.46437520561670526,
      total_abiotic_depletion: 9.618316468869875e-8,
      total_ozone_depletion: 6.469019394798301e-9,
      total_particulate_matter_formation: 5.682536501519173e-9,
      total_human_health_photochemical_ozone_creation: 0,
      total_water_use: 0.009383328432254527,
    },
  })

  expect(sumLca(Methodology.RMH, getRmhResponses)).toMatchObject({
    material: {
      total_acidification: 0,
      total_global_warming: 0,
      total_freshwater_ecotoxicity: 0,
      total_marine_ecotoxicity: 0,
      total_terrestrial_ecotoxicity: 0,
      total_energy_resources: 0,
      total_freshwater_eutrophication: 0,
      total_marine_eutrophication: 0,
      total_carcinogenic_human_toxicity: 0,
      total_non_carcinogenic_human_toxicity: 0,
      total_ionizing_radiation: 0,
      total_land_use: 0,
      total_metals_material_resources: 0,
      total_ozone_depletion: 0,
      total_particulate_matter_formation: 0,
      total_human_health_photochemical_ozone_creation: 0,
      total_terrestrial_photochemical_ozone_creation: 0,
      total_water_use: 0,
    },
    transportation: {
      total_global_warming: 0.4104623121400152,
      total_acidification: 0.0009757402643824323,
      total_freshwater_ecotoxicity: 0.0010712162751663852,
      total_marine_ecotoxicity: 0.001993613522601022,
      total_terrestrial_ecotoxicity: 0.7987760829476784,
      total_energy_resources: 0.12366809441629721,
      total_freshwater_eutrophication: 0.00000557693263773393,
      total_marine_eutrophication: 0.00000825896606542905,
      total_carcinogenic_human_toxicity: 0.0034432666574951937,
      total_non_carcinogenic_human_toxicity: 0.10033750291489804,
      total_ionizing_radiation: 0.0012268181706596262,
      total_land_use: 0.0009441398198258026,
      total_metals_material_resources: 0.0018070588242024093,
      total_ozone_depletion: 2.254436578905247e-8,
      total_particulate_matter_formation: 0.0003285938749180188,
      total_human_health_photochemical_ozone_creation: 0.0018928189216429467,
      total_terrestrial_photochemical_ozone_creation: 0.001955017575275008,
      total_water_use: 0.00016654682704750332,
    },
    facility: {
      total_global_warming: 0.007306444542404864,
      total_acidification: 0.000009521026117066078,
      total_freshwater_ecotoxicity: 0.00023009824516647434,
      total_marine_ecotoxicity: 0.0003047206324221791,
      total_terrestrial_ecotoxicity: 0.006527711310962638,
      total_energy_resources: 0.0021570815826356983,
      total_freshwater_eutrophication: 0.00000552766280995909,
      total_marine_eutrophication: 3.6593991286789876e-7,
      total_carcinogenic_human_toxicity: 0.000384666845353953,
      total_non_carcinogenic_human_toxicity: 0.006689497214674986,
      total_ionizing_radiation: 0.0010141896945448372,
      total_land_use: 0.00012877587892846186,
      total_metals_material_resources: 0.00003554914900750677,
      total_ozone_depletion: 2.9650062374395688e-9,
      total_particulate_matter_formation: 0.00001812989263677519,
      total_human_health_photochemical_ozone_creation: 0.000009923050453525617,
      total_terrestrial_photochemical_ozone_creation: 0,
      total_water_use: 0,
    },
    use: {
      total_global_warming: null,
      total_acidification: null,
      total_freshwater_ecotoxicity: null,
      total_marine_ecotoxicity: null,
      total_terrestrial_ecotoxicity: null,
      total_energy_resources: null,
      total_freshwater_eutrophication: null,
      total_marine_eutrophication: null,
      total_carcinogenic_human_toxicity: null,
      total_non_carcinogenic_human_toxicity: null,
      total_ionizing_radiation: null,
      total_land_use: null,
      total_metals_material_resources: null,
      total_ozone_depletion: null,
      total_particulate_matter_formation: null,
      total_human_health_photochemical_ozone_creation: null,
      total_terrestrial_photochemical_ozone_creation: null,
      total_water_use: null,
    },
    disposal: {
      total_global_warming: 0.0075252193879325625,
      total_acidification: 0.000035312433477715165,
      total_freshwater_ecotoxicity: 0.000039243889227937646,
      total_marine_ecotoxicity: 0.000060327822594785345,
      total_terrestrial_ecotoxicity: 0.008422643223637057,
      total_energy_resources: 0.0021822842898805094,
      total_freshwater_eutrophication: 3.7551716166221024e-7,
      total_marine_eutrophication: 1.59694451725452e-7,
      total_carcinogenic_human_toxicity: 0.000275898303163877,
      total_non_carcinogenic_human_toxicity: 0.0009739161196719388,
      total_ionizing_radiation: 0.00003825797718995906,
      total_land_use: 0.0011242423691356198,
      total_metals_material_resources: 0.00009544883774531993,
      total_ozone_depletion: 2.681453981949712e-9,
      total_particulate_matter_formation: 0.000017977570440475832,
      total_human_health_photochemical_ozone_creation: 0.00007949194140307431,
      total_terrestrial_photochemical_ozone_creation: 0.00008154119851229629,
      total_water_use: 0.0000057213771913865,
    },
    lca: {
      total_global_warming: 0.42529397607035263,
      total_acidification: 0.0010205737239772136,
      total_freshwater_ecotoxicity: 0.0013405584095607971,
      total_marine_ecotoxicity: 0.0023586619776179863,
      total_terrestrial_ecotoxicity: 0.8137264374822781,
      total_energy_resources: 0.12800746028881343,
      total_freshwater_eutrophication: 0.00001148011260935523,
      total_marine_eutrophication: 0.0000087846004300224,
      total_carcinogenic_human_toxicity: 0.004103831806013024,
      total_non_carcinogenic_human_toxicity: 0.10800091624924497,
      total_ionizing_radiation: 0.0022792658423944224,
      total_land_use: 0.002197158067889884,
      total_metals_material_resources: 0.001938056810955236,
      total_ozone_depletion: 2.8190826008441754e-8,
      total_particulate_matter_formation: 0.00036470133799526984,
      total_human_health_photochemical_ozone_creation: 0.0019822339134995468,
      total_terrestrial_photochemical_ozone_creation: 0.002036558773787304,
      total_water_use: 0.00017226820423888982,
    },
  })
}, 15000)
